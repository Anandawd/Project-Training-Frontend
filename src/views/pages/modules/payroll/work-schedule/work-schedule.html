<section class="content">
  <div class="container-fluid">
    <!-- button insert -->
    <div class="d-flex justify-content-end mb-2">
      <button
        title="Switch Schedule"
        type="button"
        class="btn btn-primary mr-1"
        @click="handleShowModal('', $global.modePayroll.switchSchedule)"
      >
        <i class="fa fa-exchange-alt mr-1" aria-hidden="true"></i>{{
        $t('buttons.switchSchedule') }}
      </button>
      <button
        title="Insert Schedule"
        type="button"
        class="btn btn-primary mr-1"
        @click="handleShowForm('', $global.modeData.insert)"
      >
        <i class="fa fa-plus mr-1" aria-hidden="true"></i>{{
        $t('buttons.insert') }}
      </button>
    </div>

    <!-- insert form -->
    <transition name="fade">
      <c-input-form
        class="px-2"
        ref="inputFormElement"
        v-show="showForm"
        :schema="schema"
        :modeData="modeData"
        :employeeOptions="employeeOptions"
        :workScheduleOptions="workScheduleOptions"
        :workScheduleTypeOptions="workScheduleTypeOptions"
        @save="handleSave"
        @close="showForm=false"
      />
    </transition>

    <!-- filter -->
    <c-search-filter
      date-range
      :options="searchOptions"
      :searchDefault="searchDefault"
      @search="refreshData"
    >
    </c-search-filter>

    <!-- Weekly Schedule View -->
    <div class="card mb-3">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h3 class="card-title mb-0">
            {{$t('title.weeklySchedule')}} : {{currentWeekRange}}
          </h3>
          <div class="week-navigation">
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary mx-1"
              @click="navigateWeek(-1)"
              :title="$t('buttons.previousWeek')"
            >
              <i class="fa fa-chevron-left mx-1" aria-hidden="true"></i>{{
              $t('buttons.prevWeek')}}
            </button>
            <button
              type="button"
              class="btn btn-sm btn-primary week-nav-btn mx-1"
              @click="goToCurrentWeek"
              :title="$t('buttons.currentWeek')"
            >
              <i class="fa fa-calendar-day mr-1" aria-hidden="true"></i>
              {{$t('buttons.thisWeek')}}
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary week-nav-btn mx-1"
              @click="navigateWeek(1)"
              :title="$t('buttons.nextWeek')"
            >
              {{ $t('buttons.nextWeek')}}
              <i class="fa fa-chevron-right ml-1" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive card">
          <table class="table table-bordered table-hover schedule-table">
            <thead class="table-light">
              <tr>
                <th
                  style="width: 100px"
                  class="sticky-col align-content-center"
                >
                  {{$t('labels.payroll.employee.employee')}}
                </th>
                <th
                  v-for="(day, index) in weekDays"
                  :key="index"
                  class="text-center align-content-start"
                  style="width: 100px"
                >
                  <div class="day-header">
                    <strong>{{ day.name }}</strong>
                    <br />
                    <small class="text-muted">{{day.date}}</small>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                v-for="(employee, empIndex) in currentWeekData"
                :key="empIndex"
                class="employee-row"
              >
                <td class="align-middle sticky-col bg-light">
                  <div>
                    <strong class="employee-id"
                      >{{employee.employee_id}}</strong
                    >
                    <br />
                    <strong class="employee-name"
                      >{{employee.employee_name}}</strong
                    >
                    <br />
                    <small class="department-name"
                      >{{employee.department_name}}</small
                    >
                    <br />
                    <small class="text-muted position-name"
                      >{{employee.position_name}}</small
                    >
                  </div>
                </td>
                <td
                  v-for="(day, dayIndex) in weekDays"
                  :key="dayIndex"
                  @click="openScheduleModal(employee, day, day.day_index)"
                  class="shift-cell text-center align-middle"
                  :class="{
                    'selected': bulkEditMode && selectedCells.includes(`${employee.employee_id}-${day.day_index}`),
                    'has-conflict': checkCellConflict(employee.employee_id, day.day_index)
                  }"
                >
                  <div class="shift-content">
                    <span
                      :class="{
                        'shift-badge': true,
                        [getShiftBadgeClass(getScheduleCode(employee.employee_id, day.day_index))]: true
                      }"
                      :style="{ backgroundColor: getShiftColor(getScheduleCode(employee.employee_id, day.day_index)) }"
                    >
                      {{getScheduleCode(employee.employee_id, day.day_index)}}
                    </span>
                    <div class="shift-time">
                      <small>
                        {{getScheduleTime(employee.employee_id, day.day_index)}}
                      </small>
                    </div>
                    <div
                      v-if="getSchedule(employee.employee_id, day.day_index)?.is_overtime"
                      class="overtime-indicator"
                    >
                      <i class="fa fa-clock text-warning" title="Overtime"></i>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Legend -->
        <div class="mt-4 card border-info">
          <div class="card-header bg-light">
            <h6 class="mb-0">
              <i class="fa fa-info-circle mr-2"></i>
              {{$t('labels.payroll.attendance.legend')}}
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <!-- Front Office Shifts -->
              <div class="col-md-3 mb-2">
                <h6 class="text-muted font-weight-bold">Front Office</h6>
                <div class="legend-item">
                  <span class="badge" style="background-color: #28a745"
                    >FO-M</span
                  >
                  - Morning (07:00-15:00)
                </div>
                <div class="legend-item">
                  <span
                    class="badge"
                    style="background-color: #ffc107; color: #212529"
                    >FO-E</span
                  >
                  - Evening (15:00-23:00)
                </div>
                <div class="legend-item">
                  <span class="badge" style="background-color: #343a40"
                    >FO-N</span
                  >
                  - Night (23:00-07:00)
                </div>
              </div>

              <!-- Housekeeping Shifts -->
              <div class="col-md-3 mb-2">
                <h6 class="text-muted font-weight-bold">Housekeeping</h6>
                <div class="legend-item">
                  <span class="badge" style="background-color: #17a2b8"
                    >HK-M</span
                  >
                  - Morning (08:00-16:00)
                </div>
                <div class="legend-item">
                  <span class="badge" style="background-color: #fd7e14"
                    >HK-E</span
                  >
                  - Evening (14:00-22:00)
                </div>
              </div>

              <!-- F&B Shifts -->
              <div class="col-md-3 mb-2">
                <h6 class="text-muted font-weight-bold">F&B</h6>
                <div class="legend-item">
                  <span class="badge" style="background-color: #e83e8c"
                    >FB-B</span
                  >
                  - Breakfast (05:00-13:00)
                </div>
                <div class="legend-item">
                  <span class="badge" style="background-color: #6610f2"
                    >FB-L</span
                  >
                  - Lunch (10:00-18:00)
                </div>
                <div class="legend-item">
                  <span class="badge" style="background-color: #6f42c1"
                    >FB-D</span
                  >
                  - Dinner (16:00-00:00)
                </div>
                <div class="legend-item">
                  <span class="badge" style="background-color: #6c757d"
                    >FB-SP</span
                  >
                  - Split Shift
                </div>
              </div>

              <!-- Security & Others -->
              <div class="col-md-3 mb-2">
                <h6 class="text-muted font-weight-bold">Others</h6>
                <div class="legend-item">
                  <span class="badge" style="background-color: #dc3545"
                    >SEC</span
                  >
                  - Security (12hrs)
                </div>
                <div class="legend-item">
                  <span class="badge" style="background-color: #20c997"
                    >ENG</span
                  >
                  - Engineering
                </div>
                <div class="legend-item">
                  <span class="badge bg-secondary">OFF</span> - Day Off
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Weekly Schedule Table -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">{{$t('title.employeeSchedule')}}</h3>
      </div>
      <div class="card-body">
        <ag-grid-vue
          :style="agGridSetting.styleAgGridFrame"
          :class="agGridSetting.themeAgGrid"
          :columnDefs="columnDefs"
          :rowData="rowData"
          :paginationPageSize="paginationPageSize"
          :gridOptions="gridOptions"
          :context="context"
          :frameworkComponents="frameworkComponents"
          :enableCellChangeFlash="true"
          :rowSelection="rowSelection"
          :getContextMenuItems="getContextMenu"
          :defaultColDef="agGridSetting.defColDef"
          :rowGroupPanelShow="rowGroupPanelShow"
          :suppressDragLeaveHidesColumns="true"
          :suppressMakeColumnVisibleAfterUnGroup="true"
          :statusBar="statusBar"
          @grid-ready="onGridReady"
          @cellContextMenu="handleRowRightClicked"
        ></ag-grid-vue>
      </div>
    </div>

    <!-- Switch Schedule -->
    <c-modal
      v-show="showModal"
      :title="$t('title.switchSchedule')"
      size="lg"
      @close="showModal = false"
      @save="handleSaveModal"
    >
      <div @click.stop>
        <div class="switch-schedule-modal">
          <!-- Employee Info -->
          <div class="row mb-3">
            <div class="col-md-12">
              <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                  <h6 class="mb-0">
                    <i class="fa fa-user mr-2"></i>Employee Information
                  </h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <strong>{{modalForm.employee_name}}</strong>
                      <br /><small class="text-muted"
                        >{{modalForm.employee_id}}</small
                      >
                    </div>
                    <div class="col-md-3">
                      <strong>{{modalForm.department_name}}</strong>
                      <br /><small class="text-muted"
                        >{{modalForm.position_name}}</small
                      >
                    </div>
                    <div class="col-md-3">
                      <strong>{{modalForm.day_name}}</strong>
                      <br /><small class="text-muted">{{modalForm.date}}</small>
                    </div>
                    <div class="col-md-3">
                      <strong>Current Schedule</strong>
                      <br />
                      <span
                        class="badge"
                        :style="{ backgroundColor: getShiftColor(modalForm.current_shift_code) }"
                      >
                        {{modalForm.current_shift_code}}
                      </span>
                      <small class="d-block text-muted"
                        >{{modalForm.current_shift_name}}</small
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Current vs New Schedule Comparison -->
          <div class="row mb-3">
            <div class="col-md-6 mb-sm-3 mb-md-0">
              <div class="card border-info">
                <div class="card-header bg-info text-white">
                  <h6 class="mb-0">Current Schedule</h6>
                </div>
                <div class="card-body text-center">
                  <div class="current-schedule-display p-3">
                    <span
                      class="badge badge-lg"
                      :style="{ backgroundColor: getShiftColor(modalForm.current_shift_code), fontSize: '16px', padding: '12px 20px' }"
                    >
                      {{modalForm.current_shift_code}}
                    </span>
                    <h5 class="mt-2 mb-1">{{modalForm.current_shift_name}}</h5>
                    <p
                      class="text-muted mb-0"
                      v-if="modalForm.current_start_time"
                    >
                      {{modalForm.current_start_time}} -
                      {{modalForm.current_end_time}}
                    </p>
                    <p class="text-muted mb-0" v-else>Day Off</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-success">
                <div class="card-header bg-success text-white">
                  <h6 class="mb-0">New Schedule</h6>
                </div>
                <div class="card-body">
                  <c-select
                    required
                    offset="right"
                    class="mb-3"
                    name="NewShift"
                    labelName="name"
                    keyName="code"
                    v-model="modalForm.new_shift_code"
                    :label="$t('labels.payroll.attendance.selectNewShift')"
                    :options="availableShiftsForEmployee"
                  />

                  <div v-if="modalForm.new_shift_code" class="text-center">
                    <span
                      class="badge badge-lg"
                      :style="{ backgroundColor: getShiftColor(modalForm.new_shift_code), fontSize: '16px', padding: '12px 20px' }"
                    >
                      {{modalForm.new_shift_code}}
                    </span>
                    <h5 class="mt-2 mb-1">
                      {{getShiftName(modalForm.new_shift_code)}}
                    </h5>
                    <p class="text-muted mb-0">
                      {{getShiftTime(modalForm.new_shift_code)}}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Conflicts Display -->
          <div v-if="modalForm.new_shift_code" class="row mb-3">
            <div class="col-md-12">
              <div class="card border-warning">
                <div class="card-header bg-warning">
                  <h6 class="mb-0">
                    <i class="fa fa-exclamation-triangle mr-2"></i>Conflict
                    Check
                  </h6>
                </div>
                <div class="card-body">
                  <div v-if="!getModalConflicts().length" class="text-success">
                    <i class="fa fa-check-circle mr-2"></i>No conflicts detected
                  </div>
                  <div v-else>
                    <div
                      v-for="conflict in getModalConflicts()"
                      :key="conflict.message"
                      :class="{
                      'alert alert-danger': conflict.severity === 'error',
                      'alert alert-warning': conflict.severity === 'warning'
                    }"
                      class="mb-2"
                    >
                      <i
                        :class="{
                      'fa fa-times-circle': conflict.severity === 'error',
                      'fa fa-exclamation-triangle': conflict.severity === 'warning'
                    }"
                        class="mr-2"
                      ></i>
                      {{conflict.message}}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Reason -->
          <div class="row mb-3">
            <div class="col-md-12">
              <label class="form-label"
                >{{$t('labels.payroll.attendance.switchReason')}}</label
              >
              <textarea
                class="form-control"
                rows="3"
                v-model="modalForm.reason"
                placeholder="Enter reason for schedule change..."
              ></textarea>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex justify-content-end">
            <button
              type="button"
              class="btn btn-secondary mr-2"
              @click="showModal = false"
            >
              <i class="fa fa-times mr-1"></i>{{$t('buttons.cancel')}}
            </button>
            <button
              type="button"
              class="btn btn-primary"
              @click="handleSaveModal"
              :disabled="!modalForm.new_shift_code || getModalConflicts().some(c => c.severity === 'error')"
            >
              <i class="fa fa-save mr-1"></i>{{$t('buttons.save')}}
            </button>
          </div>
        </div>
      </div>
    </c-modal>

    <!-- dialog -->
    <c-dialog
      v-show="showDialog"
      dialogTitle="Confirm"
      size="sm"
      @confirm="confirmAction"
      @cancel="showDialog=false"
    >
      <template #body>{{dialogMessage}}</template>
    </c-dialog>
  </div>
</section>
