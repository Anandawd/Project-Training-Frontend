<section class="content">
  <div class="container-fluid">
    <!-- button insert -->
    <div class="d-flex justify-content-end mb-2">
      <button
        disabled
        title="Export Schedule"
        type="button"
        class="btn btn-secondary mr-1"
        @click="handleShowForm('', $global.modePayroll.export)"
      >
        <i class="fa fa-file-export mr-1" aria-hidden="true"></i>{{
        $t('buttons.export')}}
      </button>
      <button
        :disabled="!paramData"
        title="Switch Shift"
        type="button"
        class="btn btn-primary mr-1"
        @click="handleShowModal"
      >
        <i class="fa fa-plus mr-1" aria-hidden="true"></i>{{
        $t('buttons.switchShift') }}
      </button>
      <button
        title="Insert Schedule"
        type="button"
        class="btn btn-primary mr-1"
        @click="handleShowForm('', $global.modeData.insert)"
      >
        <i class="fa fa-plus mr-1" aria-hidden="true"></i>{{
        $t('buttons.insert') }}
      </button>
    </div>

    <!-- insert form -->
    <transition name="fade">
      <c-input-form
        class="px-2"
        ref="inputFormElement"
        v-show="showForm"
        :schema="schema"
        :modeData="modeData"
        :employeeOptions="employeeOptions"
        :workScheduleOptions="workScheduleOptions"
        :workScheduleTypeOptions="workScheduleTypeOptions"
        @save="handleSave"
        @close="showForm=false"
      />
    </transition>

    <!-- filter -->
    <c-search-filter
      date-range
      :options="searchOptions"
      :searchDefault="searchDefault"
      @search="refreshData"
    >
    </c-search-filter>

    <!-- Weekly Schedule View -->
    <div class="card mb-4">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h3 class="card-title mb-0">
            {{$t('title.weeklySchedule')}} : {{currentWeekRange}}
          </h3>
          <div class="week-navigation">
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary mx-1"
              @click="navigateWeek(-1)"
              :title="$t('buttons.previousWeek')"
            >
              <i class="fa fa-chevron-left mx-1" aria-hidden="true"></i>{{
              $t('buttons.prevWeek')}}
            </button>
            <button
              type="button"
              class="btn btn-sm btn-primary week-nav-btn mx-1"
              @click="goToCurrentWeek"
              :title="$t('buttons.currentWeek')"
            >
              <i class="fa fa-calendar-day mr-1" aria-hidden="true"></i>
              {{$t('buttons.thisWeek')}}
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary week-nav-btn mx-1"
              @click="navigateWeek(1)"
              :title="$t('buttons.nextWeek')"
            >
              {{ $t('buttons.nextWeek')}}
              <i class="fa fa-chevron-right ml-1" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover schedule-table">
            <thead class="table-light">
              <tr>
                <th style="width: 100px">
                  {{$t('labels.payroll.employee.id')}}
                </th>
                <th style="width: 120px">
                  {{$t('labels.payroll.employee.name')}}
                </th>
                <th style="width: 100px">
                  {{$t('labels.payroll.employee.department')}}
                </th>
                <th
                  v-for="(day, index) in weekDays"
                  :key="index"
                  class="text-center"
                  style="width: 100px"
                >
                  <div class="day-header">
                    <strong>{{ day.name }}</strong>
                    <br />
                    <small class="text-muted">{{day.date}}</small>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                v-for="(employee, empIndex) in currentWeekData"
                :key="empIndex"
                class="employee-row"
              >
                <td class="text-center align-middle">
                  <strong>{{employee.employee_id}}</strong>
                </td>
                <td class="align-middle">
                  <div>
                    <strong>{{employee.employee_name}}</strong>
                    <br />
                    <small class="text-muted"
                      >{{employee.work_schedule_name}}</small
                    >
                  </div>
                </td>
                <td class="text-center align-middle">
                  <small>{{employee.department_name}}</small>
                </td>
                <td
                  v-for="(day, dayIndex) in currentWeekData"
                  :key="dayIndex"
                  @click="selectedShift(employee, dayIndex)"
                  class="shift-cell text-center align-middle"
                >
                  <span
                    :class="{
                      'shift-badge': true,
                      'morning': getScheduleCode(employee.id, dayIndex) === 'M',
                      'evening': getScheduleCode(employee.id, dayIndex) === 'E',
                      'night': getScheduleCode(employee.id, dayIndex) === 'N',
                      'off': getScheduleCode(employee.id, dayIndex) === 'OFF',
                      'split': getScheduleCode(employee.id, dayIndex) === 'SP'
                    }"
                    >{{getScheduleCode(employee.id, dayIndex)}}</span
                  >
                  <div class="shift-time">
                    <small>
                      {{getSchedule(employee.id, dayIndex)?.start_time}} -
                      {{getSchedule(employee.id, dayIndex)?.end_time}}
                    </small>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- legend -->
        <div class="mt-4 card border-info">
          <div class="card-header bg-light">
            <h6 class="mb-0">
              <i class="fa fa-info-circle mr-2"></i>
              {{$t('labels.payroll.attendance.legend')}}
            </h6>
          </div>
          <div class="card-body">
            <div class="d-flex flex-wrap">
              <div class="me-4 mb-2">
                <span class="badge bg-success">M</span> - Morning
              </div>
              <div class="me-4 mb-2">
                <span class="badge bg-warning">E</span> - Evening
              </div>
              <div class="me-4 mb-2">
                <span class="badge bg-dark">N</span> - Night
              </div>
              <div class="me-4 mb-2">
                <span class="badge bg-secondary">OFF</span> - Day Off
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">{{$t('title.employeeSchedule')}}</h3>
      </div>
      <div class="card-body">
        <ag-grid-vue
          :style="agGridSetting.styleAgGridFrame"
          :class="agGridSetting.themeAgGrid"
          :columnDefs="columnDefs"
          :rowData="rowData"
          :paginationPageSize="paginationPageSize"
          :gridOptions="gridOptions"
          :context="context"
          :frameworkComponents="frameworkComponents"
          :enableCellChangeFlash="true"
          :rowSelection="rowSelection"
          :getContextMenuItems="getContextMenu"
          :defaultColDef="agGridSetting.defColDef"
          :rowGroupPanelShow="rowGroupPanelShow"
          :suppressDragLeaveHidesColumns="true"
          :suppressMakeColumnVisibleAfterUnGroup="true"
          :statusBar="statusBar"
          @grid-ready="onGridReady"
          @cellContextMenu="handleRowRightClicked"
        ></ag-grid-vue>
      </div>
    </div>

    <c-modal
      v-show="showShiftModal"
      :title="$t('title.switchShift')"
      size="md"
      @close="showShiftModal = false"
    >
      <div v-if="selectedShiftData">
        <div class="row mb-3">
          <div class="col-md-12">
            <div class="alert alert-info">
              <h6 class="mb-2">
                <i class="fa fa-user mr-2"></i>
                {{$t('labels.payroll.workSchedule.selectedEmployee')}}
              </h6>
              <div class="row">
                <div class="col-md-6">
                  <strong
                    >{{$t('labels.payroll.employee.employeeName')}}:</strong
                  >
                  {{selectedShiftData.employee_name}}
                </div>
                <div class="col-md-6">
                  <strong
                    >{{$t('labels.payroll.workSchedule.selectedDay')}}:</strong
                  >
                  {{selectedShiftData.dayName}}
                  ({{currentWeekData[selectedShiftData.dayIndex]?.date}})
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label"
              >{{$t('labels.payroll.workSchedule.currentShift')}}</label
            >
            <div class="current-shift-display">
              <span
                :class="{
              'badge rounded-pill px-3 py-2': true,
              'bg-success': selectedShiftData.currentShift === 'M',
              'bg-warning': selectedShiftData.currentShift === 'E',
              'bg-dark': selectedShiftData.currentShift === 'N',
              'bg-secondary': selectedShiftData.currentShift === 'OFF',
              'bg-info': selectedShiftData.currentShift === 'SP'
            }"
              >
                {{getShiftName(selectedShiftData.employee_id,
                selectedShiftData.dayIndex)}}
              </span>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label"
              >{{$t('labels.payroll.workSchedule.newShift')}}</label
            >
            <select class="form-control" v-model="newShiftType">
              <option value="">{{$t('labels.select')}}</option>
              <option
                v-for="shift in shiftOptions"
                :key="shift.code"
                :value="shift.code"
              >
                {{shift.name}}
              </option>
            </select>
          </div>
        </div>

        <div class="row mb-3" v-if="newShiftType && newShiftType !== 'OFF'">
          <div class="col-md-6">
            <label class="form-label"
              >{{$t('labels.payroll.workSchedule.startTime')}}</label
            >
            <input
              type="time"
              class="form-control"
              v-model="newShiftStartTime"
            />
          </div>
          <div class="col-md-6">
            <label class="form-label"
              >{{$t('labels.payroll.workSchedule.endTime')}}</label
            >
            <input type="time" class="form-control" v-model="newShiftEndTime" />
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-12">
            <label class="form-label"
              >{{$t('labels.payroll.workSchedule.switchReason')}}</label
            >
            <textarea
              class="form-control"
              rows="3"
              v-model="shiftSwitchReason"
              :placeholder="$t('labels.payroll.workSchedule.switchReasonPlaceholder')"
            ></textarea>
          </div>
        </div>

        <!-- Shift Preview -->
        <div class="row" v-if="newShiftType">
          <div class="col-md-12">
            <div class="card border-success">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fa fa-eye mr-2"></i>
                  {{$t('labels.payroll.workSchedule.shiftPreview')}}
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <strong
                      >{{$t('labels.payroll.workSchedule.newShiftType')}}:</strong
                    >
                    <span class="badge bg-primary ms-2"
                      >{{getSelectedShiftName()}}</span
                    >
                  </div>
                  <div class="col-md-4" v-if="newShiftType !== 'OFF'">
                    <strong
                      >{{$t('labels.payroll.workSchedule.workingTime')}}:</strong
                    >
                    <span class="badge bg-info ms-2"
                      >{{newShiftStartTime}} - {{newShiftEndTime}}</span
                    >
                  </div>
                  <div class="col-md-4" v-if="newShiftType !== 'OFF'">
                    <strong
                      >{{$t('labels.payroll.workSchedule.workingHours')}}:</strong
                    >
                    <span class="badge bg-success ms-2"
                      >{{calculateShiftHours()}}h</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <template #footer>
        <button
          type="button"
          class="btn btn-secondary"
          @click="showShiftModal = false"
        >
          <i class="fa fa-times mr-1"></i>
          {{$t('buttons.cancel')}}
        </button>
        <button
          type="button"
          class="btn btn-primary"
          @click="handleShiftSwitch"
          :disabled="!newShiftType"
        >
          <i class="fa fa-exchange-alt mr-1"></i>
          {{$t('buttons.switchShift')}}
        </button>
      </template>
    </c-modal>

    <!-- dialog -->
    <c-dialog
      v-show="showDialog"
      dialogTitle="Confirm"
      size="sm"
      @confirm="confirmAction"
      @cancel="showDialog=false"
    >
      <template #body>{{dialogMessage}}</template>
    </c-dialog>
  </div>
</section>
